{# ### TEN SZABLON DZIEDZICZY Z base.html ### #}
{% extends "base.html" %}

{# ### DEFINIUJESZ TYLKO BLOK, KTÓRY CHCESZ ZMIENIĆ ### #}

{# Nadpisz blok 'title' #}
{% block title %}qrades.com - tag data{% endblock %}

{# Nadpisz blok 'content' główną treścią strony głównej #}
{% block content %}

        <section class="mb-4">
          <div class="card">
           <div class="card-body">

              <div data-mdb-input-init class="form-outline mb-4">
                <input type="text" class="form-control" id="datatable-search-input" />
                <label class="form-label" for="datatable-search-input">Search...</label>
              </div>
              <div id="datatable2" data-mdb-sm="true">
              </div>

           </div>
          </div>
        </section>

        <script type="text/javascript">
          document.addEventListener('DOMContentLoaded', function() {
              // Sprawdź, czy obiekt MDB i jego komponent Datatable są dostępne
              if (typeof mdb === 'undefined' || !mdb.Datatable) {
                  console.error("MDBootstrap Datatable library is not loaded or not accessible.");
                  document.getElementById('datatable2').innerHTML = '<p class="text-danger">Błąd: Biblioteka tabeli danych nie została załadowana. Spróbuj odświeżyć stronę.</p>';
                  return; // Zatrzymaj wykonywanie skryptu, jeśli biblioteka nie jest dostępna
              }

              // Pobierz dane przekazane z Flaska za pomocą Jinja2 | tojson filtra
              // Tojson bezpiecznie konwertuje dane Pythona na JSON dla JavaScriptu
              const rawData = {{ dane | tojson }};

              if (!rawData || rawData.length === 0) {
                  document.getElementById('datatable2').innerHTML = '<p class="text-center">Brak danych do wyświetlenia.</p>';
                  return;
              }

              // Dynamiczne generowanie kolumn (nagłówków) na podstawie pierwszego elementu danych
              // Przyjmujemy, że 'full_route_id' będzie ukryte, a 'Name' będzie miało link
              const columns = [];
              const columnLabels = {
                  'Name': 'Name',
                  'Tag': 'Tag',
                  'Created': 'Created',
                  'Grade': 'Grade',
                  'Review': 'Review',
                  'Last ascend': 'Last ascend'
                  // Dodaj inne mapowania, jeśli nazwy kluczy w danych różnią się od pożądanych nagłówków
              };

              // Dodaj ukrytą kolumnę dla pełnego ID trasy (potrzebna do linków)
              columns.push({ label: 'ID (Ukryte)', field: 'full_route_id', hidden: true });

              // Generuj pozostałe kolumny dynamicznie
              // Upewnij się, że klucze są w odpowiedniej kolejności, jeśli to ważne
              const desiredOrder = ['Name', 'Tag', 'Created', 'Grade', 'Review', 'Last ascend'];

              desiredOrder.forEach(key => {
                  if (rawData[0].hasOwnProperty(key)) { // Upewnij się, że klucz istnieje w danych
                      columns.push({
                          label: columnLabels[key] || key, // Użyj zdefiniowanej etykiety lub nazwy klucza
                          field: key
                      });
                  }
              });


              // Transformacja wierszy: Konwersja na format obiektu i dodanie linków
              const rows = rawData.map(item => {
                  const rowData = { ...item }; // Skopiuj wszystkie dane z oryginalnego obiektu

                  // Tworzenie linku dla kolumny 'Name'
                  // Sprawdź, czy item.full_route_id istnieje, zanim użyjesz
                  if (item.full_route_id && item.Name) {
                      rowData.Name = `<a href="../route/${item.full_route_id}" class="text-primary text-decoration-none">${item.Name} <i class="fa-solid fa-arrow-up-right-from-square"></i></a>`;
                  } else {
                      rowData.Name = item.Name || 'N/A'; // Użyj nazwy lub 'N/A' jeśli brak
                  }

                  // Tworzenie linku dla kolumny 'tag'
                  if (item.Tag) { // Upewnij się, że tag istnieje
                      rowData.Tag = `<a href="../tag/${item.Tag}" class="text-info text-decoration-none">${item.Tag} <i class="fa-solid fa-arrow-up-right-from-square"></i></a>`;
                  } else {
                      rowData.Tag = 'Brak'; // Domyślna wartość, jeśli tag nie istnieje
                  }

                  // Formatowanie recenzji (jeśli jest liczbą)
                  if (typeof rowData.Review === 'number') {
                      rowData.Review = rowData.Review.toFixed(1); // Formatuj do jednego miejsca po przecinku
                  }

                  return rowData;
              });

              const tableData = {
                  columns: columns,
                  rows: rows,
              };

              // Inicjalizacja Datatable
              const instance = new mdb.Datatable(document.getElementById('datatable2'), tableData, {
                  loading: false,         // Pokazuje spinner ładowania
                  pagination: true,      // Włącza paginację
                  fixedHeader: true,     // Stały nagłówek dla przewijanych tabel
                  hover: true,           // Podświetla wiersze po najechaniu myszką
                  striped: false,         // Dodaje paski zebry do wierszy
                  bordered: false,        // Dodaje obramowania do komórek
                  sm: true,              // Używa mniejszego rozmiaru tabeli
                  // Inne opcje MDB Datatable:
                  entries: 10,           // Domyślna liczba wpisów na stronę
                  noRecordsText: 'Brak danych do wyświetlenia.'
              });

              // --- DODANE KODU TUTAJ ---
              // Po zainicjalizowaniu tabeli, możemy próbować ukryć kolumnę za pomocą metody Datatable
              // lub przez bezpośrednią manipulację DOM/CSS.
              // Zakładamy, że 'full_route_id' to pierwsza kolumna (indeks 0).
              if (instance && typeof instance.update === 'function') { // Sprawdź, czy instancja i metoda update istnieją
                  // MDB Datatable nie zawsze ma bezpośrednią metodę 'hideColumn'
                  // Zamiast tego, możemy spróbować manipulować DOM.
                  // Najbezpieczniej jest dodać klasę CSS, która ukryje nagłówek i komórki tej kolumny.

                  // Znajdź tabelę
                  const tableElement = document.getElementById('datatable2').querySelector('table');
                  if (tableElement) {
                      // Ukryj nagłówek kolumny (pierwszy <th> w <thead>)
                      const headerCell = tableElement.querySelector('thead th:nth-child(1)'); // Pierwsza kolumna
                      if (headerCell) {
                          headerCell.style.display = 'none';
                      }

                      // Ukryj komórki danych w każdej row (pierwsze <td> w każdym <tr> w <tbody>)
                      const dataRows = tableElement.querySelectorAll('tbody tr');
                      dataRows.forEach(row => {
                          const dataCell = row.querySelector('td:nth-child(1)'); // Pierwsza kolumna
                          if (dataCell) {
                              dataCell.style.display = 'none';
                          }
                      });
                  }
              }
              // --- KONIEC DODANEGO KODU ---

              // Obsługa wyszukiwania
              document.getElementById('datatable-search-input').addEventListener('input', (e) => {
                instance.search(e.target.value);
              });
          });
        </script>

      <section class="mb-4">
        <div class="card">
         <div class="card-body" style="min-height: 300px;">

            <canvas id="top-routes-bar-chart"></canvas>
            <script type="text/javascript">
                // Sprawdź, czy Chart.js jest załadowany globalnie
                if (typeof Chart === 'undefined') {
                    console.error("Chart.js nie został załadowany. Wykres nie będzie działać.");
                } else {
                    // Pluginy Chart.js (jeśli są używane) powinny być zarejestrowane,
                    // jeśli nie są już zarejestrowane w base.html.
                    // W tym przypadku Chart.js v4.x jest ładowany w base.html,
                    // więc globalny obiekt Chart powinien być dostępny.
                    // Jeśli używasz pluginów takich jak datalabels, annotation, zoom,
                    // upewnij się, że są one załadowane i zarejestrowane w base.html
                    // lub tutaj, jeśli są specyficzne dla tego wykresu.
                }

                const chartData = {
                    type: 'bar',
                    labels: {{ chart_labels | tojson }}, // Dane z Flaska (nazwy dróg)
                    datasets: [
                        {
                            label: 'avg review',
                            data: {{ chart_data | tojson }}, // Dane z Flaska (średnie oceny)
                            backgroundColor: 'rgba(0, 123, 255, 0.7)', // Kolor słupków
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1,
                        },
                    ],
                };

                const chartOptions = {
                    indexAxis: 'y', // Wykres słupkowy poziomy
                    responsive: true,
                    maintainAspectRatio: false, // Pozwól na własną wysokość
                    plugins: {
                        legend: {
                            display: false // Nie pokazuj legendy, bo jest tylko jeden dataset
                        },
                        title: {
                            display: true, // Usunięto tytuł wykresu
                            text: 'Top 10 - highest review' // Tekst tytułu, ale nie będzie wyświetlany
                        }
                    },
                    scales: {
                        x: { // Zgodne z Chart.js v4.x (x zamiast xAxes)
                            stacked: true, // Dodano stacked
                            beginAtZero: true,
                            title: { // Zgodne z Chart.js v4.x (title zamiast scaleLabel)
                                display: false, // Usunięto nazwę osi X
                                text: 'Średnia Ocena (1-5)' // Tekst nazwy osi X, ale nie będzie wyświetlany
                            },
                            max: 5, // Maksymalna ocena to 5
                            ticks: {
                                display: false, // ### ZMIANA: Usunięto etykiety osi X ###
                                stepSize: 1, // Krok co 1
                                color: 'rgba(0,0,0, 0.5)', // Dodano kolor ticków
                            },
                            grid: { // Zgodne z Chart.js v4.x (grid zamiast gridLines)
                                display: false, // ### ZMIANA: Usunięto pionową siatkę osi X ###
                                drawBorder: true,
                                borderDash: [2], // Dodano borderDash
                                zeroLineColor: 'rgba(0,0,0,0)', // Dodano zeroLineColor
                                zeroLineBorderDash: [2], // Dodano zeroLineBorderDash
                                zeroLineBorderDashOffset: [2], // Dodano zeroLineBorderDashOffset
                            }
                        },
                        y: { // Zgodne z Chart.js v4.x (y zamiast yAxes)
                            stacked: true, // Dodano stacked
                            title: { // Zgodne z Chart.js v4.x (title zamiast scaleLabel)
                                display: false, // Usunięto nazwę osi Y
                                text: 'Nazwa Drogi' // Tekst nazwy osi Y, ale nie będzie wyświetlany
                            },
                            grid: { // Zgodne z Chart.js v4.x (grid zamiast gridLines)
                                display: false, // Nie pokazuj siatki na osi Y
                            },
                            ticks: {
                                color: 'rgba(0,0,0, 0.5)', // Dodano kolor ticków
                                callback: function(value, index, values) { // ### ZMIANA: Skrócenie etykiet osi Y ###
                                    const label = this.getLabelForValue(value);
                                    return label.length > 10 ? label.substring(0, 7) + '...' : label;
                                }
                            },
                        }
                    }
                };

                // Stwórz wykres
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('top-routes-bar-chart');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: chartData,
                            options: chartOptions,
                        });
                    } else {
                        console.error("Element canvas o ID 'top-routes-bar-chart' nie został znaleziony.");
                    }
                });
            </script>

         </div>
        </div>
      </section>

       <section class="mb-4">
        <div class="card">
         <div class="card-body" style="min-height: 300px;">

            <canvas id="top-routes-bar-chart2"></canvas>
            <script type="text/javascript">
                // Sprawdź, czy Chart.js jest załadowany globalnie
                if (typeof Chart === 'undefined') {
                    console.error("Chart.js nie został załadowany. Wykres nie będzie działać.");
                } else {
                    // Pluginy Chart.js (jeśli są używane) powinny być zarejestrowane,
                    // jeśli nie są już zarejestrowane w base.html.
                    // W tym przypadku Chart.js v4.x jest ładowany w base.html,
                    // więc globalny obiekt Chart powinien być dostępny.
                    // Jeśli używasz pluginów takich jak datalabels, annotation, zoom,
                    // upewnij się, że są one załadowane i zarejestrowane w base.html
                    // lub tutaj, jeśli są specyficzne dla tego wykresu.
                }

                const chartData2 = {
                    type: 'bar',
                    labels: {{ chart_labels2 | tojson }}, // Dane z Flaska (nazwy dróg)
                    datasets: [
                        {
                            label: '# ascends',
                            data: {{ chart_data2 | tojson }}, // Dane z Flaska (średnie oceny)
                            backgroundColor: 'rgba(0, 123, 255, 0.7)', // Kolor słupków
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1,
                        },
                    ],
                };

                const chartOptions2 = {
                    indexAxis: 'y', // Wykres słupkowy poziomy
                    responsive: true,
                    maintainAspectRatio: false, // Pozwól na własną wysokość
                    plugins: {
                        legend: {
                            display: false // Nie pokazuj legendy, bo jest tylko jeden dataset
                        },
                        title: {
                            display: true, // Usunięto tytuł wykresu
                            text: 'Top 10 - most ascends by route' // Tekst tytułu, ale nie będzie wyświetlany
                        }
                    },
                    scales: {
                        x: { // Zgodne z Chart.js v4.x (x zamiast xAxes)
                            stacked: true, // Dodano stacked
                            beginAtZero: true,
                            title: { // Zgodne z Chart.js v4.x (title zamiast scaleLabel)
                                display: false, // Usunięto nazwę osi X
                                text: 'Średnia Ocena (1-5)' // Tekst nazwy osi X, ale nie będzie wyświetlany
                            },
                            max: 5, // Maksymalna ocena to 5
                            ticks: {
                                display: false, // ### ZMIANA: Usunięto etykiety osi X ###
                                stepSize: 1, // Krok co 1
                                color: 'rgba(0,0,0, 0.5)', // Dodano kolor ticków
                            },
                            grid: { // Zgodne z Chart.js v4.x (grid zamiast gridLines)
                                display: false, // ### ZMIANA: Usunięto pionową siatkę osi X ###
                                drawBorder: true,
                                borderDash: [2], // Dodano borderDash
                                zeroLineColor: 'rgba(0,0,0,0)', // Dodano zeroLineColor
                                zeroLineBorderDash: [2], // Dodano zeroLineBorderDash
                                zeroLineBorderDashOffset: [2], // Dodano zeroLineBorderDashOffset
                            }
                        },
                        y: { // Zgodne z Chart.js v4.x (y zamiast yAxes)
                            stacked: true, // Dodano stacked
                            title: { // Zgodne z Chart.js v4.x (title zamiast scaleLabel)
                                display: false, // Usunięto nazwę osi Y
                                text: 'Nazwa Drogi' // Tekst nazwy osi Y, ale nie będzie wyświetlany
                            },
                            grid: { // Zgodne z Chart.js v4.x (grid zamiast gridLines)
                                display: false, // Nie pokazuj siatki na osi Y
                            },
                            ticks: {
                                color: 'rgba(0,0,0, 0.5)', // Dodano kolor ticków
                                callback: function(value, index, values) { // ### ZMIANA: Skrócenie etykiet osi Y ###
                                    const label = this.getLabelForValue(value);
                                    return label.length > 10 ? label.substring(0, 7) + '...' : label;
                                }
                            },
                        }
                    }
                };

                // Stwórz wykres
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('top-routes-bar-chart2');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: chartData2,
                            options: chartOptions2,
                        });
                    } else {
                        console.error("Element canvas o ID 'top-routes-bar-chart' nie został znaleziony.");
                    }
                });
            </script>

         </div>
        </div>
      </section>

       <section class="mb-4">
        <div class="card">
         <div class="card-body">

            <canvas id="top-routes-bar-chart3" style="min-height: 300px;"></canvas>
            <script type="text/javascript">
                // Sprawdź, czy Chart.js jest załadowany globalnie
                if (typeof Chart === 'undefined') {
                    console.error("Chart.js nie został załadowany. Wykres nie będzie działać.");
                } else {
                    // Pluginy Chart.js (jeśli są używane) powinny być zarejestrowane,
                    // jeśli nie są już zarejestrowane w base.html.
                    // W tym przypadku Chart.js v4.x jest ładowany w base.html,
                    // więc globalny obiekt Chart powinien być dostępny.
                    // Jeśli używasz pluginów takich jak datalabels, annotation, zoom,
                    // upewnij się, że są one załadowane i zarejestrowane w base.html
                    // lub tutaj, jeśli są specyficzne dla tego wykresu.
                }

                const chartData3 = {
                    type: 'bar',
                    labels: {{ chart_labels3 | tojson }}, // Dane z Flaska (nazwy dróg)
                    datasets: [
                        {
                            label: '# ascends',
                            data: {{ chart_data3 | tojson }}, // Dane z Flaska (średnie oceny)
                            backgroundColor: 'rgba(0, 123, 255, 0.7)', // Kolor słupków
                            borderColor: 'rgba(0, 123, 255, 1)',
                            borderWidth: 1,
                        },
                    ],
                };

                const chartOptions3 = {
                    indexAxis: 'y', // Wykres słupkowy poziomy
                    responsive: true,
                    maintainAspectRatio: false, // Pozwól na własną wysokość
                    plugins: {
                        legend: {
                            display: false // Nie pokazuj legendy, bo jest tylko jeden dataset
                        },
                        title: {
                            display: true, // Usunięto tytuł wykresu
                            text: 'Top 10 - most ascends by user' // Tekst tytułu, ale nie będzie wyświetlany
                        }
                    },
                    scales: {
                        x: { // Zgodne z Chart.js v4.x (x zamiast xAxes)
                            stacked: true, // Dodano stacked
                            beginAtZero: true,
                            title: { // Zgodne z Chart.js v4.x (title zamiast scaleLabel)
                                display: false, // Usunięto nazwę osi X
                                text: 'Średnia Ocena (1-5)' // Tekst nazwy osi X, ale nie będzie wyświetlany
                            },
                            max: 5, // Maksymalna ocena to 5
                            ticks: {
                                display: false, // ### ZMIANA: Usunięto etykiety osi X ###
                                stepSize: 1, // Krok co 1
                                color: 'rgba(0,0,0, 0.5)', // Dodano kolor ticków
                            },
                            grid: { // Zgodne z Chart.js v4.x (grid zamiast gridLines)
                                display: false, // ### ZMIANA: Usunięto pionową siatkę osi X ###
                                drawBorder: true,
                                borderDash: [2], // Dodano borderDash
                                zeroLineColor: 'rgba(0,0,0,0)', // Dodano zeroLineColor
                                zeroLineBorderDash: [2], // Dodano zeroLineBorderDash
                                zeroLineBorderDashOffset: [2], // Dodano zeroLineBorderDashOffset
                            }
                        },
                        y: { // Zgodne z Chart.js v4.x (y zamiast yAxes)
                            stacked: true, // Dodano stacked
                            title: { // Zgodne z Chart.js v4.x (title zamiast scaleLabel)
                                display: false, // Usunięto nazwę osi Y
                                text: 'Nazwa Drogi' // Tekst nazwy osi Y, ale nie będzie wyświetlany
                            },
                            grid: { // Zgodne z Chart.js v4.x (grid zamiast gridLines)
                                display: false, // Nie pokazuj siatki na osi Y
                            },
                            ticks: {
                                color: 'rgba(0,0,0, 0.5)', // Dodano kolor ticków
                                callback: function(value, index, values) { // ### ZMIANA: Skrócenie etykiet osi Y ###
                                    const label = this.getLabelForValue(value);
                                    return label.length > 10 ? label.substring(0, 7) + '...' : label;
                                }
                            },
                        }
                    }
                };

                // Stwórz wykres
                document.addEventListener('DOMContentLoaded', function() {
                    const ctx = document.getElementById('top-routes-bar-chart3');
                    if (ctx) {
                        new Chart(ctx, {
                            type: 'bar',
                            data: chartData3,
                            options: chartOptions3,
                        });
                    } else {
                        console.error("Element canvas o ID 'top-routes-bar-chart' nie został znaleziony.");
                    }
                });
            </script>

         </div>
        </div>
      </section>

    {% endblock %}

{# Nie definiujemy innych bloków (head_extra, scripts_extra), jeśli nie są potrzebne #}

